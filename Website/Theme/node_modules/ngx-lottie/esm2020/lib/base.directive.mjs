import { Directive, Input, Output, Inject, PLATFORM_ID, NgZone, } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { Subject, BehaviorSubject, Observable, defer } from 'rxjs';
import { filter, switchMap, takeUntil } from 'rxjs/operators';
import { AnimationLoader } from './animation-loader';
import * as i0 from "@angular/core";
import * as i1 from "./animation-loader";
export class BaseDirective {
    constructor(ngZone, platformId, animationLoader) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this.animationLoader = animationLoader;
        this.options = null;
        this.containerClass = null;
        this.styles = null;
        /**
         * `animationCreated` is dispatched after calling `loadAnimation`.
         */
        this.animationCreated = this.getAnimationItem();
        /**
         * `complete` is dispatched after completing the last frame.
         */
        this.complete = this.awaitAnimationItemAndStartListening('complete');
        /**
         * `loopComplete` is dispatched after completing the frame loop.
         */
        this.loopComplete = this.awaitAnimationItemAndStartListening('loopComplete');
        /**
         * `enterFrame` is dispatched after entering the new frame.
         */
        this.enterFrame = this.awaitAnimationItemAndStartListening('enterFrame');
        /**
         * `segmentStart` is dispatched when the new segment is adjusted.
         */
        this.segmentStart = this.awaitAnimationItemAndStartListening('segmentStart');
        /**
         * Original event name is `config_ready`. `config_ready` is dispatched
         * after the needed renderer is configured.
         */
        this.configReady = this.awaitAnimationItemAndStartListening('config_ready');
        /**
         * Original event name is `data_ready`. `data_ready` is dispatched
         * when all parts of the animation have been loaded.
         */
        this.dataReady = this.awaitAnimationItemAndStartListening('data_ready');
        /**
         * Original event name is `DOMLoaded`. `DOMLoaded` is dispatched
         * when elements have been added to the DOM.
         */
        this.domLoaded = this.awaitAnimationItemAndStartListening('DOMLoaded');
        /**
         * `destroy` will be dispatched when the component gets destroyed,
         * it's handy for releasing resources.
         */
        this.destroy = this.awaitAnimationItemAndStartListening('destroy');
        /**
         * `error` will be dispatched if the Lottie player could not render
         * some frame or parse config.
         */
        this.error = this.awaitAnimationItemAndStartListening('error');
        this.destroy$ = new Subject();
        this.loadAnimation$ = new Subject();
        this.animationItem$ = new BehaviorSubject(null);
        this.setupLoadAnimationListener();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroyAnimation();
    }
    loadAnimation(changes, container) {
        this.loadAnimation$.next([changes, container]);
    }
    getAnimationItem() {
        return defer(() => this.animationItem$).pipe(filter((animationItem) => animationItem !== null));
    }
    awaitAnimationItemAndStartListening(name) {
        return this.getAnimationItem().pipe(switchMap(animationItem => 
        // `fromEvent` will try to call `removeEventListener` when `unsubscribe()` is invoked.
        // The problem is that `ngOnDestroy()` is called before Angular unsubscribes from
        // `@Output()` properties, thus `animationItem` will be `null` already, also `lottie-web`
        // removes event listeners when calling `destroy()`.
        new Observable(observer => {
            animationItem.addEventListener(name, event => {
                this.ngZone.runOutsideAngular(() => {
                    observer.next(event);
                });
            });
        })));
    }
    setupLoadAnimationListener() {
        this.loadAnimation$
            .pipe(filter(([changes]) => isPlatformBrowser(this.platformId) && changes.options !== undefined), switchMap(([changes, container]) => {
            this.destroyAnimation();
            return this.animationLoader.loadAnimation(this.animationLoader.resolveOptions(changes.options.currentValue, container));
        }), takeUntil(this.destroy$))
            .subscribe(animationItem => {
            this.animationItem$.next(animationItem);
        });
    }
    destroyAnimation() {
        const animationItem = this.animationItem$.getValue();
        // The `ng-lottie` component or the `lottie` directive can be destroyed
        // before the `animationItem` is set, thus it will fail with
        // `Cannot read property 'destroy' of null`.
        // Potentially it can happen if the directive gets destroyed before change
        // detection is run.
        if (animationItem === null) {
            return;
        }
        // `destroy()` will remove all events listeners.
        animationItem.destroy();
        this.animationItem$.next(null);
    }
}
/** @nocollapse */ /** @nocollapse */ BaseDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: BaseDirective, deps: [{ token: i0.NgZone }, { token: PLATFORM_ID }, { token: i1.AnimationLoader }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ /** @nocollapse */ BaseDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.2", type: BaseDirective, selector: "[lottie]", inputs: { options: "options", containerClass: "containerClass", styles: "styles" }, outputs: { animationCreated: "animationCreated", complete: "complete", loopComplete: "loopComplete", enterFrame: "enterFrame", segmentStart: "segmentStart", configReady: "configReady", dataReady: "dataReady", domLoaded: "domLoaded", destroy: "destroy", error: "error" }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: BaseDirective, decorators: [{
            type: Directive,
            args: [{ selector: '[lottie]' }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i1.AnimationLoader }]; }, propDecorators: { options: [{
                type: Input
            }], containerClass: [{
                type: Input
            }], styles: [{
                type: Input
            }], animationCreated: [{
                type: Output
            }], complete: [{
                type: Output
            }], loopComplete: [{
                type: Output
            }], enterFrame: [{
                type: Output
            }], segmentStart: [{
                type: Output
            }], configReady: [{
                type: Output
            }], dataReady: [{
                type: Output
            }], domLoaded: [{
                type: Output
            }], destroy: [{
                type: Output
            }], error: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neC1sb3R0aWUvc3JjL2xpYi9iYXNlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUNOLFdBQVcsRUFHWCxNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFcEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQWM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7OztBQUdyRCxNQUFNLE9BQU8sYUFBYTtJQXFFeEIsWUFDVSxNQUFjLEVBQ08sVUFBa0IsRUFDdkMsZUFBZ0M7UUFGaEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNPLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDdkMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBdkVqQyxZQUFPLEdBQTRCLElBQUksQ0FBQztRQUV4QyxtQkFBYyxHQUFrQixJQUFJLENBQUM7UUFFckMsV0FBTSxHQUF3QyxJQUFJLENBQUM7UUFFNUQ7O1dBRUc7UUFDTyxxQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUVyRDs7V0FFRztRQUNPLGFBQVEsR0FBRyxJQUFJLENBQUMsbUNBQW1DLENBQWtCLFVBQVUsQ0FBQyxDQUFDO1FBRTNGOztXQUVHO1FBQ08saUJBQVksR0FDcEIsSUFBSSxDQUFDLG1DQUFtQyxDQUFzQixjQUFjLENBQUMsQ0FBQztRQUVoRjs7V0FFRztRQUNPLGVBQVUsR0FBRyxJQUFJLENBQUMsbUNBQW1DLENBQW9CLFlBQVksQ0FBQyxDQUFDO1FBRWpHOztXQUVHO1FBQ08saUJBQVksR0FDcEIsSUFBSSxDQUFDLG1DQUFtQyxDQUFzQixjQUFjLENBQUMsQ0FBQztRQUVoRjs7O1dBR0c7UUFDTyxnQkFBVyxHQUFHLElBQUksQ0FBQyxtQ0FBbUMsQ0FBTyxjQUFjLENBQUMsQ0FBQztRQUV2Rjs7O1dBR0c7UUFDTyxjQUFTLEdBQUcsSUFBSSxDQUFDLG1DQUFtQyxDQUFPLFlBQVksQ0FBQyxDQUFDO1FBRW5GOzs7V0FHRztRQUNPLGNBQVMsR0FBRyxJQUFJLENBQUMsbUNBQW1DLENBQU8sV0FBVyxDQUFDLENBQUM7UUFFbEY7OztXQUdHO1FBQ08sWUFBTyxHQUFHLElBQUksQ0FBQyxtQ0FBbUMsQ0FBaUIsU0FBUyxDQUFDLENBQUM7UUFFeEY7OztXQUdHO1FBQ08sVUFBSyxHQUNiLElBQUksQ0FBQyxtQ0FBbUMsQ0FBK0MsT0FBTyxDQUFDLENBQUM7UUFFMUYsYUFBUSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDL0IsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBZ0MsQ0FBQztRQUM3RCxtQkFBYyxHQUFHLElBQUksZUFBZSxDQUF1QixJQUFJLENBQUMsQ0FBQztRQU92RSxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVTLGFBQWEsQ0FBQyxPQUFzQixFQUFFLFNBQXNCO1FBQ3BFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVPLGdCQUFnQjtRQUN0QixPQUFPLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUMxQyxNQUFNLENBQ0osQ0FBQyxhQUFtQyxFQUFrQyxFQUFFLENBQ3RFLGFBQWEsS0FBSyxJQUFJLENBQ3pCLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyxtQ0FBbUMsQ0FBSSxJQUF3QjtRQUNyRSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLElBQUksQ0FDakMsU0FBUyxDQUNQLGFBQWEsQ0FBQyxFQUFFO1FBQ2Qsc0ZBQXNGO1FBQ3RGLGlGQUFpRjtRQUNqRix5RkFBeUY7UUFDekYsb0RBQW9EO1FBQ3BELElBQUksVUFBVSxDQUFJLFFBQVEsQ0FBQyxFQUFFO1lBQzNCLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBSSxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFO29CQUNqQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN2QixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQ0wsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVPLDBCQUEwQjtRQUNoQyxJQUFJLENBQUMsY0FBYzthQUNoQixJQUFJLENBQ0gsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDLEVBQzFGLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQUU7WUFDakMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDeEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FDdkMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQzdFLENBQUM7UUFDSixDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUN6QjthQUNBLFNBQVMsQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUN6QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNyRCx1RUFBdUU7UUFDdkUsNERBQTREO1FBQzVELDRDQUE0QztRQUM1QywwRUFBMEU7UUFDMUUsb0JBQW9CO1FBQ3BCLElBQUksYUFBYSxLQUFLLElBQUksRUFBRTtZQUMxQixPQUFPO1NBQ1I7UUFFRCxnREFBZ0Q7UUFDaEQsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7O2dKQWpKVSxhQUFhLHdDQXVFZCxXQUFXO29JQXZFVixhQUFhOzJGQUFiLGFBQWE7a0JBRHpCLFNBQVM7bUJBQUMsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFOzswQkF3RTlCLE1BQU07MkJBQUMsV0FBVzswRUF0RVosT0FBTztzQkFBZixLQUFLO2dCQUVHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBRUcsTUFBTTtzQkFBZCxLQUFLO2dCQUtJLGdCQUFnQjtzQkFBekIsTUFBTTtnQkFLRyxRQUFRO3NCQUFqQixNQUFNO2dCQUtHLFlBQVk7c0JBQXJCLE1BQU07Z0JBTUcsVUFBVTtzQkFBbkIsTUFBTTtnQkFLRyxZQUFZO3NCQUFyQixNQUFNO2dCQU9HLFdBQVc7c0JBQXBCLE1BQU07Z0JBTUcsU0FBUztzQkFBbEIsTUFBTTtnQkFNRyxTQUFTO3NCQUFsQixNQUFNO2dCQU1HLE9BQU87c0JBQWhCLE1BQU07Z0JBTUcsS0FBSztzQkFBZCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBJbmplY3QsXG4gIFBMQVRGT1JNX0lELFxuICBPbkRlc3Ryb3ksXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE5nWm9uZSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmltcG9ydCB7IFN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgZGVmZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgc3dpdGNoTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEFuaW1hdGlvbk9wdGlvbnMsXG4gIEJNQ29tcGxldGVFdmVudCxcbiAgQk1Db21wbGV0ZUxvb3BFdmVudCxcbiAgQk1FbnRlckZyYW1lRXZlbnQsXG4gIEJNU2VnbWVudFN0YXJ0RXZlbnQsXG4gIEJNRGVzdHJveUV2ZW50LFxuICBCTVJlbmRlckZyYW1lRXJyb3JFdmVudCxcbiAgQk1Db25maWdFcnJvckV2ZW50LFxuICBBbmltYXRpb25JdGVtLFxuICBBbmltYXRpb25FdmVudE5hbWUsXG59IGZyb20gJy4vc3ltYm9scyc7XG5pbXBvcnQgeyBBbmltYXRpb25Mb2FkZXIgfSBmcm9tICcuL2FuaW1hdGlvbi1sb2FkZXInO1xuXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbbG90dGllXScgfSlcbmV4cG9ydCBjbGFzcyBCYXNlRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgQElucHV0KCkgb3B0aW9uczogQW5pbWF0aW9uT3B0aW9ucyB8IG51bGwgPSBudWxsO1xuXG4gIEBJbnB1dCgpIGNvbnRhaW5lckNsYXNzOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICBASW5wdXQoKSBzdHlsZXM6IFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj4gfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICogYGFuaW1hdGlvbkNyZWF0ZWRgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY2FsbGluZyBgbG9hZEFuaW1hdGlvbmAuXG4gICAqL1xuICBAT3V0cHV0KCkgYW5pbWF0aW9uQ3JlYXRlZCA9IHRoaXMuZ2V0QW5pbWF0aW9uSXRlbSgpO1xuXG4gIC8qKlxuICAgKiBgY29tcGxldGVgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY29tcGxldGluZyB0aGUgbGFzdCBmcmFtZS5cbiAgICovXG4gIEBPdXRwdXQoKSBjb21wbGV0ZSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1Db21wbGV0ZUV2ZW50PignY29tcGxldGUnKTtcblxuICAvKipcbiAgICogYGxvb3BDb21wbGV0ZWAgaXMgZGlzcGF0Y2hlZCBhZnRlciBjb21wbGV0aW5nIHRoZSBmcmFtZSBsb29wLlxuICAgKi9cbiAgQE91dHB1dCgpIGxvb3BDb21wbGV0ZSA9XG4gICAgdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxCTUNvbXBsZXRlTG9vcEV2ZW50PignbG9vcENvbXBsZXRlJyk7XG5cbiAgLyoqXG4gICAqIGBlbnRlckZyYW1lYCBpcyBkaXNwYXRjaGVkIGFmdGVyIGVudGVyaW5nIHRoZSBuZXcgZnJhbWUuXG4gICAqL1xuICBAT3V0cHV0KCkgZW50ZXJGcmFtZSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1FbnRlckZyYW1lRXZlbnQ+KCdlbnRlckZyYW1lJyk7XG5cbiAgLyoqXG4gICAqIGBzZWdtZW50U3RhcnRgIGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgbmV3IHNlZ21lbnQgaXMgYWRqdXN0ZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgc2VnbWVudFN0YXJ0ID1cbiAgICB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPEJNU2VnbWVudFN0YXJ0RXZlbnQ+KCdzZWdtZW50U3RhcnQnKTtcblxuICAvKipcbiAgICogT3JpZ2luYWwgZXZlbnQgbmFtZSBpcyBgY29uZmlnX3JlYWR5YC4gYGNvbmZpZ19yZWFkeWAgaXMgZGlzcGF0Y2hlZFxuICAgKiBhZnRlciB0aGUgbmVlZGVkIHJlbmRlcmVyIGlzIGNvbmZpZ3VyZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgY29uZmlnUmVhZHkgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdjb25maWdfcmVhZHknKTtcblxuICAvKipcbiAgICogT3JpZ2luYWwgZXZlbnQgbmFtZSBpcyBgZGF0YV9yZWFkeWAuIGBkYXRhX3JlYWR5YCBpcyBkaXNwYXRjaGVkXG4gICAqIHdoZW4gYWxsIHBhcnRzIG9mIHRoZSBhbmltYXRpb24gaGF2ZSBiZWVuIGxvYWRlZC5cbiAgICovXG4gIEBPdXRwdXQoKSBkYXRhUmVhZHkgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdkYXRhX3JlYWR5Jyk7XG5cbiAgLyoqXG4gICAqIE9yaWdpbmFsIGV2ZW50IG5hbWUgaXMgYERPTUxvYWRlZGAuIGBET01Mb2FkZWRgIGlzIGRpc3BhdGNoZWRcbiAgICogd2hlbiBlbGVtZW50cyBoYXZlIGJlZW4gYWRkZWQgdG8gdGhlIERPTS5cbiAgICovXG4gIEBPdXRwdXQoKSBkb21Mb2FkZWQgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdET01Mb2FkZWQnKTtcblxuICAvKipcbiAgICogYGRlc3Ryb3lgIHdpbGwgYmUgZGlzcGF0Y2hlZCB3aGVuIHRoZSBjb21wb25lbnQgZ2V0cyBkZXN0cm95ZWQsXG4gICAqIGl0J3MgaGFuZHkgZm9yIHJlbGVhc2luZyByZXNvdXJjZXMuXG4gICAqL1xuICBAT3V0cHV0KCkgZGVzdHJveSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1EZXN0cm95RXZlbnQ+KCdkZXN0cm95Jyk7XG5cbiAgLyoqXG4gICAqIGBlcnJvcmAgd2lsbCBiZSBkaXNwYXRjaGVkIGlmIHRoZSBMb3R0aWUgcGxheWVyIGNvdWxkIG5vdCByZW5kZXJcbiAgICogc29tZSBmcmFtZSBvciBwYXJzZSBjb25maWcuXG4gICAqL1xuICBAT3V0cHV0KCkgZXJyb3IgPVxuICAgIHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1SZW5kZXJGcmFtZUVycm9yRXZlbnQgfCBCTUNvbmZpZ0Vycm9yRXZlbnQ+KCdlcnJvcicpO1xuXG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICBwcml2YXRlIGxvYWRBbmltYXRpb24kID0gbmV3IFN1YmplY3Q8W1NpbXBsZUNoYW5nZXMsIEhUTUxFbGVtZW50XT4oKTtcbiAgcHJpdmF0ZSBhbmltYXRpb25JdGVtJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QW5pbWF0aW9uSXRlbSB8IG51bGw+KG51bGwpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBhbmltYXRpb25Mb2FkZXI6IEFuaW1hdGlvbkxvYWRlcixcbiAgKSB7XG4gICAgdGhpcy5zZXR1cExvYWRBbmltYXRpb25MaXN0ZW5lcigpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95QW5pbWF0aW9uKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgbG9hZEFuaW1hdGlvbihjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzLCBjb250YWluZXI6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgdGhpcy5sb2FkQW5pbWF0aW9uJC5uZXh0KFtjaGFuZ2VzLCBjb250YWluZXJdKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QW5pbWF0aW9uSXRlbSgpOiBPYnNlcnZhYmxlPEFuaW1hdGlvbkl0ZW0+IHtcbiAgICByZXR1cm4gZGVmZXIoKCkgPT4gdGhpcy5hbmltYXRpb25JdGVtJCkucGlwZShcbiAgICAgIGZpbHRlcihcbiAgICAgICAgKGFuaW1hdGlvbkl0ZW06IEFuaW1hdGlvbkl0ZW0gfCBudWxsKTogYW5pbWF0aW9uSXRlbSBpcyBBbmltYXRpb25JdGVtID0+XG4gICAgICAgICAgYW5pbWF0aW9uSXRlbSAhPT0gbnVsbCxcbiAgICAgICksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8VD4obmFtZTogQW5pbWF0aW9uRXZlbnROYW1lKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QW5pbWF0aW9uSXRlbSgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoXG4gICAgICAgIGFuaW1hdGlvbkl0ZW0gPT5cbiAgICAgICAgICAvLyBgZnJvbUV2ZW50YCB3aWxsIHRyeSB0byBjYWxsIGByZW1vdmVFdmVudExpc3RlbmVyYCB3aGVuIGB1bnN1YnNjcmliZSgpYCBpcyBpbnZva2VkLlxuICAgICAgICAgIC8vIFRoZSBwcm9ibGVtIGlzIHRoYXQgYG5nT25EZXN0cm95KClgIGlzIGNhbGxlZCBiZWZvcmUgQW5ndWxhciB1bnN1YnNjcmliZXMgZnJvbVxuICAgICAgICAgIC8vIGBAT3V0cHV0KClgIHByb3BlcnRpZXMsIHRodXMgYGFuaW1hdGlvbkl0ZW1gIHdpbGwgYmUgYG51bGxgIGFscmVhZHksIGFsc28gYGxvdHRpZS13ZWJgXG4gICAgICAgICAgLy8gcmVtb3ZlcyBldmVudCBsaXN0ZW5lcnMgd2hlbiBjYWxsaW5nIGBkZXN0cm95KClgLlxuICAgICAgICAgIG5ldyBPYnNlcnZhYmxlPFQ+KG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIGFuaW1hdGlvbkl0ZW0uYWRkRXZlbnRMaXN0ZW5lcjxUPihuYW1lLCBldmVudCA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGV2ZW50KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KSxcbiAgICAgICksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBMb2FkQW5pbWF0aW9uTGlzdGVuZXIoKTogdm9pZCB7XG4gICAgdGhpcy5sb2FkQW5pbWF0aW9uJFxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoW2NoYW5nZXNdKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpICYmIGNoYW5nZXMub3B0aW9ucyAhPT0gdW5kZWZpbmVkKSxcbiAgICAgICAgc3dpdGNoTWFwKChbY2hhbmdlcywgY29udGFpbmVyXSkgPT4ge1xuICAgICAgICAgIHRoaXMuZGVzdHJveUFuaW1hdGlvbigpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbkxvYWRlci5sb2FkQW5pbWF0aW9uKFxuICAgICAgICAgICAgdGhpcy5hbmltYXRpb25Mb2FkZXIucmVzb2x2ZU9wdGlvbnMoY2hhbmdlcy5vcHRpb25zLmN1cnJlbnRWYWx1ZSwgY29udGFpbmVyKSxcbiAgICAgICAgICApO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShhbmltYXRpb25JdGVtID0+IHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25JdGVtJC5uZXh0KGFuaW1hdGlvbkl0ZW0pO1xuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lBbmltYXRpb24oKTogdm9pZCB7XG4gICAgY29uc3QgYW5pbWF0aW9uSXRlbSA9IHRoaXMuYW5pbWF0aW9uSXRlbSQuZ2V0VmFsdWUoKTtcbiAgICAvLyBUaGUgYG5nLWxvdHRpZWAgY29tcG9uZW50IG9yIHRoZSBgbG90dGllYCBkaXJlY3RpdmUgY2FuIGJlIGRlc3Ryb3llZFxuICAgIC8vIGJlZm9yZSB0aGUgYGFuaW1hdGlvbkl0ZW1gIGlzIHNldCwgdGh1cyBpdCB3aWxsIGZhaWwgd2l0aFxuICAgIC8vIGBDYW5ub3QgcmVhZCBwcm9wZXJ0eSAnZGVzdHJveScgb2YgbnVsbGAuXG4gICAgLy8gUG90ZW50aWFsbHkgaXQgY2FuIGhhcHBlbiBpZiB0aGUgZGlyZWN0aXZlIGdldHMgZGVzdHJveWVkIGJlZm9yZSBjaGFuZ2VcbiAgICAvLyBkZXRlY3Rpb24gaXMgcnVuLlxuICAgIGlmIChhbmltYXRpb25JdGVtID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gYGRlc3Ryb3koKWAgd2lsbCByZW1vdmUgYWxsIGV2ZW50cyBsaXN0ZW5lcnMuXG4gICAgYW5pbWF0aW9uSXRlbS5kZXN0cm95KCk7XG4gICAgdGhpcy5hbmltYXRpb25JdGVtJC5uZXh0KG51bGwpO1xuICB9XG59XG4iXX0=